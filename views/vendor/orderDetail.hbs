<div class="container--">
    <div class="card container--content" id="list">
     
    </div>

    <div class="card container--content vendor--order__history">
        <h4>Order history</h4>
        <ul class="list-group" id="history">
           
        </ul>
    </div>
    <div id="getting-started"></div>
</div>


<script id="tpl-list" type="text/html">
    <% for(var i = 0; i < list.length; i++){ %>
            <div class="card-body">
                <a href="/vendor/orderDetail/<%= list[i]._id %>">
                    <div class="row">
                        <div class="col-10">
                            <h5 class="card-title"><%= list[i].orderNumber %></h5>
                            <p>
                                <%= list[i].snacks.length %> orders - <%= list[i].customerID.firstName%>
                            </p>
                        </div>

                        <div class="col-2">
                            <div class="text--muted alert alert-primary" data-time="<%= list[i].updatedAt %>"></div>
                        </div>
                    </div>
                </a>
            </div>
    <% } %>
    <% if (list.length <= 0) { %>
        <div class="row">
            <div class="col-12 text-center">
                <p>
                    <img src="/img/order-icon.png">
                </p>
                <h3>No orders</h3>
                <p class="text-secondary">You don't have any orders in your history.</p>
            </div>
        </div>
    <% } %>
</script>

<script id="tpl-history-list" type="text/html">
    <% for(var i = 0; i < historyList.length; i++){ %>
        <li class="list-group-item list-group-item-secondary">
            <%= historyList[i].orderNumber %>
        </li>
    <% } %>

</script>

<script type="text/javascript">
   $(function() {
       // time limit to give a discount for orders (15 mins)
        var DISCOUNT_TIME = 15 * 60 * 1000; 

       // Get order list
        function getOrderList(type) {

            if (type !== 'polling') {
                gbmsg.loading()
            }
            
            $.ajax({
                type: 'GET',
                url: '/vendor/api/order'
            }).done(function( res ) {
                var list = res || []

                console.log('list',list)

                var html = template('tpl-list', {list:list})
                $('#list').html(html)

                // countdown
                
                setTimeout(() => {
                    $('#list').find('.text--muted').each(function() {
                    var updatedAt = $(this).attr('data-time')

                    var time = new Date(updatedAt).getTime() + DISCOUNT_TIME;
                    $(this).countdown(time, function(event) {
                        console.log('event', event.strftime('%M'))
                        var minute =  Number(event.strftime('%M'))

                        // 10-5 minutes show the yellow box
                        if (minute <= 10 && minute > 5) {
                            $(this).addClass('alert-warning')    
                        } else if (minute <= 5) {
                        // Less than 5 minutes to show the red box
                            $(this).removeClass('alert-warning').addClass('alert-danger')      
                        }

                        $(this).text(event.strftime('%M:%S'));
                        })
                    });
                }, 100)

            }).fail(function(jqXHR) {
                console.log('jqXHR', jqXHR)
                var res = jqXHR.responseJSON || {}
                var errs = res.errors || []

                gbmsg.failure(errs[0] || 'Failed！')
            }).always(function() { 
                gbmsg.hide()
            });
        }

        // Get order history
        function getOrderHistoryList(type) {

            if (type !== 'polling') {
                gbmsg.loading()
            }
            
            $.ajax({
                type: 'GET',
                url: '/vendor/api/history'
            }).done(function( res ) {
                var historyList = res || []

                console.log('historyList',historyList)

                var html = template('tpl-history-list', {historyList:historyList})
                $('#history').html(html)

            }).fail(function(jqXHR) {
                console.log('jqXHR', jqXHR)
                var res = jqXHR.responseJSON || {}
                var errs = res.errors || []

                gbmsg.failure(errs[0] || 'Failed！')
            }).always(function() { 
                gbmsg.hide()
            });
        }

        getOrderList()
        getOrderHistoryList()

        // Polling for order status updates
        setInterval(() => {
            getOrderList('polling')
            getOrderHistoryList('polling')
        },30000)        
        
   });
</script>

